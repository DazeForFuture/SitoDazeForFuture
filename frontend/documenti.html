<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Daze for Future" />
  <title>Documenti - Daze for Future</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/sidebar/sidebar.css" />
  <link rel="stylesheet" href="css/sidebar/hamburger.css" />
  <link rel="stylesheet" href="css/userbar/userbar.css" />
  <link rel="icon" href="immagini/logo.ico" type="image/x-icon" />

  <style>
    /* === THEME TOKENS === */
    :root {
      --bg: #fff;
      --text: #1d1d1f;
      --muted: #6e6e73;
      --footer-bg: #f9f9f9;
      --hover-bg: rgba(0, 0, 0, 0.05);
      --btn-bg: var(--text);
      --btn-hover-bg: #333;
      --header-bg: rgba(255, 255, 255, 0.95);
      --header-text: #1d1d1f;
      --sidebar-bg: rgba(255, 255, 255, 0.98);
      --sidebar-border: rgba(0, 0, 0, 0.15);
      --sidebar-shadow: rgba(0, 0, 0, 0.15);
      --accent: #007aff;
      --admin-badge: #ff3b30;
      --user-badge: #34c759;
      --overlay-light: rgba(255, 255, 255, 0.6);
      --overlay-dark: rgba(29, 29, 31, 0.8);
      --card-bg: rgba(255, 255, 255, 0.9);
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      --success: #34c759;
      --error: #ff3b30;
      --warning: #ff9500;
      --info: #007aff;
    }

    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) {
        --bg: #1d1d1f;
        --text: #f5f5f7;
        --muted: #a1a1a6;
        --footer-bg: #111;
        --hover-bg: rgba(255, 255, 255, 0.05);
        --btn-bg: var(--text);
        --btn-hover-bg: #ddd;
        --header-bg: rgba(29, 29, 31, 0.95);
        --header-text: #ffffff;
        --sidebar-bg: rgba(29, 29, 31, 0.98);
        --sidebar-border: rgba(255, 255, 255, 0.15);
        --sidebar-shadow: rgba(0, 0, 0, 0.4);
        --accent: #0a84ff;
        --admin-badge: #ff453a;
        --user-badge: #30d158;
        --overlay-light: rgba(255, 255, 255, 0.6);
        --overlay-dark: rgba(29, 29, 31, 0.8);
        --card-bg: rgba(29, 29, 31, 0.9);
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        --success: #30d158;
        --error: #ff453a;
        --warning: #ff9f0a;
        --info: #0a84ff;
      }
    }

    :root[data-theme="dark"] {
      --bg: #1d1d1f;
      --text: #f5f5f7;
      --muted: #a1a1a6;
      --footer-bg: #111;
      --hover-bg: rgba(255, 255, 255, 0.05);
      --btn-bg: var(--text);
      --btn-hover-bg: #ddd;
      --header-bg: rgba(29, 29, 31, 0.95);
      --header-text: #ffffff;
      --sidebar-bg: rgba(29, 29, 31, 0.98);
      --sidebar-border: rgba(255, 255, 255, 0.15);
      --sidebar-shadow: rgba(0, 0, 0, 0.4);
      --accent: #0a84ff;
      --admin-badge: #ff453a;
      --user-badge: #30d158;
      --overlay-light: rgba(255, 255, 255, 0.6);
      --overlay-dark: rgba(29, 29, 31, 0.8);
      --card-bg: rgba(29, 29, 31, 0.9);
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      --success: #30d158;
      --error: #ff453a;
      --warning: #ff9f0a;
      --info: #0a84ff;
    }

    :root[data-theme="light"] {
      --bg: #fff;
      --text: #1d1d1f;
      --muted: #6e6e73;
      --footer-bg: #f9f9f9;
      --hover-bg: rgba(0, 0, 0, 0.05);
      --btn-bg: var(--text);
      --btn-hover-bg: #333;
      --header-bg: rgba(255, 255, 255, 0.95);
      --header-text: #1d1d1f;
      --sidebar-bg: rgba(255, 255, 255, 0.98);
      --sidebar-border: rgba(0, 0, 0, 0.15);
      --sidebar-shadow: rgba(0, 0, 0, 0.15);
      --accent: #007aff;
      --admin-badge: #ff3b30;
      --user-badge: #34c759;
      --overlay-light: rgba(255, 255, 255, 0.6);
      --overlay-dark: rgba(29, 29, 31, 0.8);
      --card-bg: rgba(255, 255, 255, 0.9);
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      --success: #34c759;
      --error: #ff3b30;
      --warning: #ff9500;
      --info: #007aff;
    }

    /* === BASE === */
    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      line-height: 1.5;
      background-image: url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?auto=format&fit=crop&w=2074&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: -1;
      transition: background 0.3s ease;
    }
    :root[data-theme="light"] body::before { background: var(--overlay-light); }
    :root[data-theme="dark"] body::before { background: var(--overlay-dark); }
    :root:not([data-theme]) body::before { background: var(--overlay-light); }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) body::before { background: var(--overlay-dark); }
    }

    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 2rem; z-index: 1000;
      color: var(--header-text);
      border-bottom: 1px solid rgba(255,255,255,0.2);
      background: var(--header-bg);
    }

    .logo { font-weight: 800; font-size: 1.4rem; cursor: pointer; user-select: none; color: var(--header-text); display: flex; align-items: center; gap: 12px; }
    .logo-img { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

    nav { display: flex; align-items: center; }
    nav > a { margin-left: 2rem; text-decoration: none; color: var(--header-text); font-weight: 600; position: relative; padding: 0.5rem; }
    nav > a::after { content: ""; position: absolute; left: 0; bottom: -4px; width: 0; height: 2px; background: var(--text); transition: width 0.3s; }
    nav > a:hover::after { width: 100%; }

    section { padding: 140px 2rem 100px; max-width: 1200px; margin: auto; }

    .hero { text-align: center; padding-top: 200px; position: relative; overflow: hidden; }
    .hero h1 { font-size: 3.2rem; font-weight: 800; margin-bottom: 1rem; background: linear-gradient(90deg, #007aff, #00c6ff); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: fadeInUp 1s ease; }
    .hero p { font-size: 1.25rem; color: var(--muted); margin-bottom: 2rem; animation: fadeInUp 1s ease 0.2s both; }

    .btn { display: inline-flex; align-items: center; gap: 8px; background-color: var(--btn-bg); color: var(--bg); padding: 0.75rem 1.5rem; border-radius: 12px; text-decoration: none; font-weight: 600; transition: transform 0.3s, background 0.3s, box-shadow 0.3s; cursor: pointer; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn:hover { background-color: var(--btn-hover-bg); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
    .btn:active { transform: translateY(0); }
    .btn-accent { background: linear-gradient(90deg, #007aff, #00c6ff); color: #fff; }
    .btn-accent:hover { background: linear-gradient(90deg, #0062cc, #0099cc); }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
    .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
    .btn-outline:hover { background: var(--accent); color: #fff; }

    .section-title { font-size: 2rem; font-weight: 800; margin-bottom: 1rem; background: linear-gradient(90deg, #007aff, #00c6ff); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    .text-muted { color: var(--muted); line-height: 1.6; font-size: 1.1rem; }

    footer { text-align: center; padding: 2rem; color: var(--muted); font-size: 0.9rem; background: var(--footer-bg); position: relative; z-index: 1; }

    /* Cards */
    .card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 16px; padding: 2rem; box-shadow: var(--card-shadow); margin-bottom: 2rem; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid rgba(255,255,255,0.1); }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }

    /* Anim */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in-up { animation: fadeInUp 0.8s ease; }

    /* Role sections */
    .admin-only { display: none; }
    .user-only { display: none; }

    /* Document list */
    .document-list { margin-top: 2rem; }
    .document-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); transition: background 0.3s; border-radius: 8px; }
    .document-item:hover { background: var(--hover-bg); }
    .document-info { display: flex; align-items: center; flex: 1; gap: 1rem; }
    .document-icon { font-size: 1.5rem; min-width: 40px; }
    .document-details { flex: 1; }
    .document-details h3 { font-size: 1rem; margin: 0 0 0.25rem; display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
    .document-details p { font-size: 0.875rem; color: var(--muted); }
    .document-actions { display: flex; gap: 0.5rem; }

    .action-btn { background: none; border: none; padding: 0.5rem; border-radius: 8px; cursor: pointer; transition: background 0.3s, color 0.3s; color: var(--text); display: flex; align-items: center; justify-content: center; }
    .action-btn:hover { background: var(--hover-bg); }
    .delete-btn:hover { color: var(--error); }
    .download-btn:hover { color: var(--accent); }
    .view-btn:hover { color: var(--info); }
    .publish-btn { color: var(--success); }
    .unpublish-btn { color: var(--warning); }

    .empty-state { text-align: center; padding: 2rem; color: var(--muted); }

    .status-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
    .status-published { background: rgba(52, 199, 89, 0.2); color: var(--success); }
    .draft-badge { background: rgba(255, 149, 0, 0.2); color: var(--warning); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }

    .cloud-indicator { display: inline-flex; align-items: center; gap: 0.25rem; background: rgba(0, 122, 255, 0.1); color: var(--accent); padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; }

    .review-notes { background: rgba(255,149,0,0.1); padding: 0.75rem; border-radius: 8px; border-left: 3px solid #ff9500; margin-top: 1rem; font-size: 0.9rem; }

    /* Viewer modal */
    #viewerModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    #viewerContent { background: var(--card-bg); padding: 2rem; border-radius: 16px; max-width: 90vw; max-height: 90vh; width: 800px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); position: relative; }
    .viewer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .viewer-title { font-size: 1.5rem; font-weight: 700; color: var(--text); margin: 0; }
    .viewer-body { max-height: 70vh; overflow-y: auto; padding: 1rem 0; }
    .viewer-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); }
    .file-preview { text-align: center; padding: 2rem; }
    .file-preview img { max-width: 100%; max-height: 400px; border-radius: 8px; }
    .unsupported-format { padding: 3rem; color: var(--muted); font-size: 1.1rem; }

    /* Publication modal */
    #publicationModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    #publicationForm { background: var(--card-bg); padding: 2.5rem; border-radius: 20px; max-width: 600px; width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); position: relative; }
    .close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: all 0.3s ease; }
    .close-btn:hover { background: var(--hover-bg); color: var(--text); }

    .form-section { margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .form-section-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; color: var(--accent); display: flex; align-items: center; gap: 0.5rem; }
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-size: 0.9rem; }
    input, textarea, select { width: 100%; padding: 0.75rem 1rem; border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.95rem; transition: all 0.3s ease; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
    textarea { resize: vertical; min-height: 120px; }

    /* Add (+) */
    #addDocumentBtn { display: none; margin-left: 2rem; font-size: 1.5rem; background: var(--accent); color: #fff; border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    #addDocumentBtn:hover { transform: scale(1.1); background: #0056cc; box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
    #addDocumentBtn:active { transform: scale(0.9); }

    /* Popup */
    .popup { position: fixed; top: 20px; right: 20px; background: var(--card-bg); color: var(--text); padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-20px); transition: all 0.4s ease; z-index: 2000; font-weight: 600; max-width: 300px; backdrop-filter: blur(10px); }
    .popup.show { opacity: 1; transform: translateY(0); }
    .popup.success { border-left: 6px solid var(--success); }
    .popup.error { border-left: 6px solid var(--error); }

    /* Filters */
    .document-filters { display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 2rem; padding: 1.5rem; background: var(--card-bg); border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; }
    .document-filters:hover { box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
    .filter-group { display: flex; flex-direction: column; min-width: 180px; flex: 1; }
    .filter-group label { font-size: 0.85rem; margin-bottom: 0.75rem; color: var(--text); font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .filter-group select { padding: 0.85rem 1rem; border: 2px solid rgba(255,255,255,0.15); border-radius: 12px; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; font-size: 0.95rem; transition: all 0.3s ease; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%236e6e73' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 12px; }
    .filter-group select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); transform: translateY(-2px); }
    .filter-group select:hover { border-color: var(--accent); }

    .filter-actions { display: flex; align-items: flex-end; margin-left: auto; }
    #resetFilters { background: transparent; border: 2px solid var(--muted); color: var(--muted); padding: 0.85rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
    #resetFilters:hover { background: var(--muted); color: var(--bg); border-color: var(--muted); transform: translateY(-2px); }

    /* Badges */
    .type-badge { display: inline-block; padding: 0.35rem 0.75rem; border-radius: 10px; font-size: 0.8rem; font-weight: 600; margin-right: 0.5rem; transition: all 0.3s ease; }
    .type-statuto { background: rgba(0, 122, 255, 0.15); color: var(--info); border: 1px solid rgba(0, 122, 255, 0.3); }
    .type-relazione { background: rgba(52, 199, 89, 0.15); color: var(--success); border: 1px solid rgba(52, 199, 89, 0.3); }
    .type-verbale { background: rgba(255, 149, 0, 0.15); color: var(--warning); border: 1px solid rgba(255, 149, 0, 0.3); }
    .type-bilancio { background: rgba(175, 82, 222, 0.15); color: #af52de; border: 1px solid rgba(175, 82, 222, 0.3); }
    .type-altro { background: rgba(142, 142, 147, 0.15); color: var(--muted); border: 1px solid rgba(142, 142, 147, 0.3); }

    /* Table (admin) */
    .documents-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .documents-table th, .documents-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .documents-table th { font-weight: 600; color: var(--muted); font-size: 0.9rem; }
    .documents-table tr:hover { background: var(--hover-bg); }

    /* Dropdown (top nav) */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-toggle { margin-left: 2rem; text-decoration: none; color: var(--header-text); font-weight: 600; position: relative; padding: 0.5rem; background: none; border: none; font-family: inherit; font-size: inherit; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .dropdown-toggle::after { content: "‚ñº"; font-size: 0.7rem; margin-left: 4px; transition: transform 0.3s ease; }
    .dropdown:hover .dropdown-toggle::after { transform: rotate(180deg); }
    .dropdown-menu { position: absolute; top: 100%; left: 0; background: var(--sidebar-bg); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border: 1px solid var(--sidebar-border); border-radius: 12px; box-shadow: var(--card-shadow); min-width: 200px; padding: 0.5rem 0; z-index: 1001; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; }
    .dropdown:hover .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-item { display: block; padding: 0.75rem 1.5rem; text-decoration: none; color: var(--text); font-weight: 500; transition: background 0.3s ease; border: none; background: none; width: 100%; text-align: left; font-family: inherit; font-size: inherit; cursor: pointer; }
    .dropdown-item:hover { background: var(--hover-bg); }
    .dropdown-divider { height: 1px; background: var(--sidebar-border); margin: 0.25rem 0; }

    /* Mobile create CTA */
    .mobile-create-section { display: none; margin-bottom: 2rem; text-align: center; }
    .mobile-create-btn-large { display: inline-flex; align-items: center; gap: 12px; background: var(--accent); color: #fff; padding: 1rem 2rem; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; border: none; box-shadow: 0 6px 20px rgba(0,0,0,0.2); width: 100%; justify-content: center; }
    .mobile-create-btn-large:hover { background: var(--btn-hover-bg); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .mobile-create-btn-large:active { transform: translateY(-1px); }

    @media (max-width: 768px) {
      header { padding: 0.8rem 1rem; }
      .logo { font-size: 1.2rem; }
      nav > a { margin-left: 1rem; font-size: 0.9rem; }
      .hero h1 { font-size: 2.2rem; }
      .section { padding: 120px 1rem 80px; }
      .hero { padding-top: 160px; }
      .card { padding: 1.5rem; }
      #mainNav { display: none; }
      #sidebarToggle { display: flex; }
      .document-item { flex-direction: column; align-items: flex-start; }
      .document-actions { margin-top: 1rem; width: 100%; justify-content: flex-end; }
      #viewerContent { margin: 1rem; padding: 1.5rem; width: auto; }
      .viewer-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
      .viewer-actions { flex-direction: column; }
      .mobile-create-section { display: block; }
      #addDocumentBtn { display: none !important; }
    }

    @media (max-width: 480px) {
      .mobile-create-btn-large { padding: 0.9rem 1.5rem; font-size: 1rem; }
    }

    /* Sidebar trigger */
    #sidebarToggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--header-text); padding: 0.5rem; }
    @media (max-width: 768px) { #sidebarToggle { display: flex; } }

    /* Theme FAB */
    #theme-fab { position: fixed; bottom: 24px; right: 24px; background: var(--accent); color: #fff; width: 56px; height: 56px; border-radius: 50%; font-size: 1.7rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.25); z-index: 3000; transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease; animation: float 3s ease-in-out infinite; }
    #theme-fab:hover { background: var(--btn-hover-bg); transform: scale(1.1); box-shadow: 0 8px 18px rgba(0,0,0,0.35); }
    #theme-fab:active { transform: scale(0.92) rotate(15deg); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    #theme-fab.show { animation: fabPopIn 0.4s ease forwards; }
    @keyframes fabPopIn { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 70% { transform: scale(1.15) rotate(10deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

    #theme-popup { position: fixed; bottom: 90px; right: 24px; background: var(--sidebar-bg); border: 1px solid var(--sidebar-border); box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 12px; display: none; flex-direction: column; padding: 0.5rem; z-index: 3001; backdrop-filter: blur(10px); opacity: 0; transform: translateY(10px) scale(0.95); transition: opacity 0.25s ease, transform 0.25s ease; }
    #theme-popup.show { display: flex; opacity: 1; transform: translateY(0) scale(1); }
    #theme-popup button.theme-option { background: none; border: none; font-size: 1.5rem; padding: 0.6rem; cursor: pointer; color: var(--text); transition: background 0.25s, transform 0.25s, color 0.25s; border-radius: 8px; }
    #theme-popup button.theme-option:hover { background: var(--hover-bg); transform: scale(1.2) rotate(8deg); }
    #theme-popup button.theme-option:active { transform: scale(0.9) rotate(-8deg); }
    #theme-popup button.theme-option.active { background: var(--accent); color: #fff; transform: scale(1.15); }

    /* Nav login link color */
    nav a[href="login.html"], nav a[href="login.html"]:visited { color: var(--accent) !important; font-weight: 700; }
    nav a[href="login.html"]:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <button class="logo" id="toggleSidebar" aria-label="Apri menu laterale">
      <img src="immagini/logo.jpg" alt="Logo Daze for Future" class="logo-img" />
      <span>Daze for Future</span>
    </button>
    <div style="flex:1"></div>

    <nav id="mainNav" aria-label="Navigazione principale">
      <a href="index.html">Home</a>
      <a href="missione.html">Missione</a>
      <a href="prossimi_eventi.html">Eventi</a>

      <div class="dropdown">
        <button class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">Progetti</button>
        <div class="dropdown-menu" role="menu">
          <a href="centrale_meteo.html" class="dropdown-item" role="menuitem">
            <i class="fas fa-cloud-sun" style="margin-right:8px" aria-hidden="true"></i>
            Centrale Meteorologica
          </a>
        </div>
      </div>

      <a href="chi_siamo.html">Chi siamo</a>
      <a href="contatti.html">Contatti</a>

      <!-- Userbar (hidden by default) -->
      <div id="userbar" class="user-info" style="display:none; align-items:center; gap:10px">
        <div class="user-avatar" id="userAvatar" aria-hidden="true"></div>
        <div class="user-display">
          <span class="user-name" id="userName"></span>
          <span class="user-badge" id="userBadge"></span>
        </div>
        <button class="logout-btn" type="button" onclick="logout()" aria-label="Logout">
          <span>Logout</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M17 7L21 12M21 12L17 17M21 12H9M13 17V18C13 19.6569 11.6569 21 10 21H6C4.34315 21 3 19.6569 3 18V6C3 4.34315 4.34315 3 6 3H10C11.6569 3 13 4.34315 13 6V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
      </div>

      <a href="login.html" id="loginLink">Accedi</a>
      <button id="addDocumentBtn" title="Crea nuovo documento" aria-label="Crea nuovo documento">+</button>
    </nav>

    <button id="sidebarToggle" class="hamburger" aria-label="Apri menu">‚ò∞</button>
  </header>

  <main>
    <section class="hero" aria-labelledby="page-title">
      <div class="hero-content">
        <h1 id="page-title">Documenti</h1>
        <p>Consulta e gestisci i documenti dell'associazione</p>
      </div>
    </section>

    <section>
      <!-- Mobile create CTA -->
      <div class="mobile-create-section fade-in-up">
        <button class="mobile-create-btn-large" id="mobileCreateBtnLarge">
          <span class="mobile-create-icon" aria-hidden="true">+</span>
          <span class="mobile-create-text">Crea Nuovo Documento</span>
        </button>
      </div>

      <!-- Filters -->
      <div class="card fade-in-up" aria-labelledby="filters-title">
        <h2 class="section-title" id="filters-title">Filtra Documenti</h2>
        <div class="document-filters">
          <div class="filter-group">
            <label for="typeFilter">Tipo Documento</label>
            <select id="typeFilter">
              <option value="all">Tutti i tipi</option>
              <option value="statuto">Statuto</option>
              <option value="relazione">Relazione</option>
              <option value="verbale">Verbale</option>
              <option value="bilancio">Bilancio</option>
              <option value="altro">Altro</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="statusFilter">Stato</label>
            <select id="statusFilter">
              <option value="all">Tutti gli stati</option>
              <option value="published">Pubblicato</option>
              <option value="draft">Bozza</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="dateFilter">Ordina per data</label>
            <select id="dateFilter">
              <option value="newest">Pi√π recenti</option>
              <option value="oldest">Pi√π vecchi</option>
            </select>
          </div>

          <div class="filter-actions">
            <button class="btn" id="resetFilters" type="button" aria-label="Reset filtri">
              <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l1.903 1.903h-3.183a.75.75 0 1 0 0 1.5h4.992a.75.75 0 0 0 .75-.75V4.356a.75.75 0 0 0-1.5 0v3.18l-1.9-1.9A9 9 0 0 0 3.306 9.67a.75.75 0 1 0 1.45.388Zm15.408 3.352a.75.75 0 0 0-.919.53 7.5 7.5 0 0 1-12.548 3.364l-1.902-1.903h3.183a.75.75 0 0 0 0-1.5H2.984a.75.75 0 0 0-.75.75v4.992a.75.75 0 0 0 1.5 0v-3.18l1.9 1.9a9 9 0 0 0 15.059-4.035.75.75 0 0 0-.53-.918Z" clip-rule="evenodd" />
              </svg>
              Reset Filtri
            </button>
          </div>
        </div>
      </div>

      <!-- Admin: drafts -->
      <div class="card admin-only fade-in-up" id="reviewSection">
        <h2 class="section-title">Bozze da Revisionare (Non Pubblicate)</h2>
        <div class="document-list" id="draftList">
          <div class="empty-state" id="emptyDrafts">
            <p>Nessuna bozza da revisionare al momento.</p>
          </div>
        </div>
      </div>

      <!-- Published -->
      <div class="card fade-in-up">
        <h2 class="section-title" id="publishedSectionTitle">Documenti Pubblicati</h2>
        <div class="document-list" id="documentList">
          <div class="empty-state" id="emptyState">
            <p>Nessun documento disponibile al momento.</p>
          </div>
        </div>
      </div>

      <!-- User: my drafts (placeholder) -->
      <div class="card user-only fade-in-up" id="myDraftsSection" style="display: none;">
        <h2 class="section-title">Le Mie Bozze <span class="cloud-indicator" aria-label="Salvate nel cloud">‚òÅÔ∏è Salvate nel cloud</span></h2>
        <div class="document-list" id="myDraftsList">
          <div class="empty-state" id="emptyMyDrafts">
            <p>Non hai ancora creato bozze.</p>
            <p class="text-muted">Crea la tua prima pubblicazione usando il pulsante in alto.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Viewer modal -->
  <div id="viewerModal" role="dialog" aria-modal="true" aria-labelledby="viewerTitle">
    <div id="viewerContent">
      <div class="viewer-header">
        <h3 class="viewer-title" id="viewerTitle">Documento</h3>
        <button class="close-btn" id="closeViewer" type="button" aria-label="Chiudi">&times;</button>
      </div>
      <div class="viewer-body" id="viewerBody">
        <div class="file-preview">
          <div class="unsupported-format">
            <p>Anteprima non disponibile per questo formato.</p>
            <p>Scarica il file per visualizzarlo.</p>
          </div>
        </div>
      </div>
      <div class="viewer-actions">
        <button class="btn" id="downloadFromViewer" type="button" aria-label="Scarica">
          <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 1 1 1.06-1.06l3.22 3.22V3a.75.75 0 0 1 .75-.75Zm-9 13.5a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
          </svg>
          Scarica
        </button>
        <button class="btn btn-outline" id="closeViewerBtn" type="button">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- Publication modal -->
  <div id="publicationModal" role="dialog" aria-modal="true" aria-labelledby="publicationTitleHeading">
    <form id="publicationForm">
      <button type="button" class="close-btn" id="closeModal" aria-label="Chiudi">&times;</button>
      <h2 id="publicationTitleHeading" style="margin-bottom: 1.5rem; color: var(--text); font-size: 1.8rem; text-align: center;">Crea Nuova Pubblicazione</h2>

      <div class="form-section">
        <div class="form-section-title">
          <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 9a.75.75 0 0 0-1.5 0v2.25H9a.75.75 0 0 0 0 1.5h2.25V15a.75.75 0 0 0 1.5 0v-2.25H15a.75.75 0 0 0 0-1.5h-2.25V9Z" clip-rule="evenodd"/></svg>
          Informazioni Base
        </div>
        <div class="form-group">
          <label for="publicationTitle">Titolo *</label>
          <input type="text" id="publicationTitle" placeholder="Es: Relazione Attivit√† 2024" required />
        </div>
        <div class="form-group">
          <label for="publicationDescription">Descrizione *</label>
          <textarea id="publicationDescription" placeholder="Descrivi il contenuto del documento..." rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label for="publicationType">Tipo Documento *</label>
          <div class="document-type-selector" role="list">
            <button class="document-type-option" data-type="statuto" type="button" role="listitem" aria-pressed="false">
              <svg class="document-type-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 16.5 9h-1.875a1.875 1.875 0 0 1-1.875-1.875V5.25A3.75 3.75 0 0 0 9 1.5H5.625ZM7.5 15a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5h-7.5A.75.75 0 0 1 7.5 15Zm.75 2.25a.75.75 0 0 0 0 1.5h3a.75.75 0 0 0 0-1.5h-3Z" clip-rule="evenodd"/><path d="M12.971 1.816A5.23 5.23 0 0 1 14.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 0 1 3.434 1.279 9.768 9.768 0 0 0-6.963-6.963Z"/></svg>
              <div class="document-type-name">Statuto</div>
            </button>
            <button class="document-type-option" data-type="relazione" type="button" role="listitem" aria-pressed="false">
              <svg class="document-type-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M2.25 13.5a8.25 8.25 0 0 1 8.25-8.25.75.75 0 0 1 .75.75v6.75H18a.75.75 0 0 1 .75.75 8.25 8.25 0 0 1-16.5 0Z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M12.75 3a.75.75 0 0 1 .75-.75 8.25 8.25 0 0 1 8.25 8.25.75.75 0 0 1-.75.75h-7.5a.75.75 0 0 1-.75-.75V3Z" clip-rule="evenodd"/></svg>
              <div class="document-type-name">Relazione</div>
            </button>
            <button class="document-type-option" data-type="verbale" type="button" role="listitem" aria-pressed="false">
              <svg class="document-type-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd"/></svg>
              <div class="document-type-name">Verbale</div>
            </button>
            <button class="document-type-option" data-type="bilancio" type="button" role="listitem" aria-pressed="false">
              <svg class="document-type-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 7.5a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z"/><path fill-rule="evenodd" d="M1.5 4.875C1.5 3.839 2.34 3 3.375 3h17.25c1.035 0 1.875.84 1.875 1.875v9.75c0 1.036-.84 1.875-1.875 1.875H3.375A1.875 1.875 0 0 1 1.5 14.625v-9.75ZM8.25 9.75a3.75 3.75 0 1 1 7.5 0 3.75 3.75 0 0 1-7.5 0ZM18.75 9a.75.75 0 0 0-.75.75v.008c0 .414.336.75.75.75h.008a.75.75 0 0 0 .75-.75V9.75a.75.75 0 0 0-.75-.75h-.008ZM4.5 9.75A.75.75 0 0 1 5.25 9h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H5.25a.75.75 0 0 1-.75-.75V9.75Z" clip-rule="evenodd"/><path d="M2.25 18a.75.75 0 0 0 0 1.5c5.4 0 10.63.722 15.6 2.075 1.19.324 2.4-.558 2.4-1.82V18.75a.75.75 0 0 0-.75-.75H2.25Z"/></svg>
              <div class="document-type-name">Bilancio</div>
            </button>
            <button class="document-type-option" data-type="altro" type="button" role="listitem" aria-pressed="false">
              <svg class="document-type-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.625 1.5H9a3.75 3.75 0 0 1 3.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 0 1 3.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 0 1-1.875-1.875V3.375c0-1.036.84-1.875 1.875-1.875ZM9.75 17.25a.75.75 0 0 0-1.5 0V18a3 3 0 1 0 6 0v-.75a.75.75 0 0 0-1.5 0V18a1.5 1.5 0 0 1-3 0v-.75Z" clip-rule="evenodd"/><path d="M14.25 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 16.5 7.5h-1.875a.375.375 0 0 1-.375-.375V5.25Z"/></svg>
              <div class="document-type-name">Altro</div>
            </button>
          </div>
          <input type="hidden" id="publicationType" required />
        </div>
      </div>

      <div class="form-section">
        <div class="form-section-title">
          <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M18.97 2.659a2.25 2.25 0 0 0-3.182 0l-10.94 10.94a3.75 3.75 0 1 0 5.304 5.303l7.693-7.693a.75.75 0 0 1 1.06 1.06l-7.693 7.693a5.25 5.25 0 1 1-7.424-7.424l10.939-10.94a3.75 3.75 0 1 1 5.303 5.304L9.097 18.835l-.008.008-.007.007-.002.002-.003.002A2.25 2.25 0 0 1 5.91 15.66l7.81-7.81a.75.75 0 0 1 1.061 1.06l-7.81 7.81a.75.75 0 0 0 1.054 1.068L18.97 5.84a2.25 2.25 0 0 0 0-3.182Z" clip-rule="evenodd"/></svg>
          Documento
        </div>
        <div class="form-group">
          <label for="publicationFile">File del documento *</label>
          <input type="file" id="publicationFile" required accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.xls,.xlsx,.ppt,.pptx,.zip" />
          <small style="color: var(--muted); font-size: 0.8rem; margin-top: 0.5rem; display:block">Supporta: PDF, DOC, DOCX, TXT, immagini, Excel, PowerPoint, ZIP (max 10MB)</small>
        </div>
      </div>

      <div class="form-actions" style="display:flex; gap:1rem; justify-content:flex-end; border-top:1px solid rgba(255,255,255,0.1); padding-top:1.5rem">
        <button type="button" class="btn" id="cancelPublication" style="background: var(--muted);">Annulla</button>
        <button type="submit" class="btn" id="submitPublication">
          <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10.5 3.75a6 6 0 0 0-5.98 6.496A5.25 5.25 0 0 0 6.75 20.25H18a4.5 4.5 0 0 0 2.206-8.423 3.75 3.75 0 0 0-4.133-4.303A6.001 6.001 0 0 0 10.5 3.75Zm2.03 5.47a.75.75 0 0 0-1.06 0l-3 3a.75.75 0 1 0 1.06 1.06l1.72-1.72v4.94a.75.75 0 0 0 1.5 0v-4.94l1.72 1.72a.75.75 0 1 0 1.06-1.06l-3-3Z" clip-rule="evenodd"/></svg>
          Crea Bozza
        </button>
      </div>
    </form>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Menu laterale">
    <button class="sidebar-close" type="button" aria-label="Chiudi menu">&times;</button>
    <h2>Menu</h2>
    <ul class="sidebar-menu">
      <li><a href="index.html"><span>üè†</span>Home</a></li>
      <li><a href="missione.html"><span>üå±</span> Missione</a></li>
      <li><a href="prossimi_eventi.html"><span>üìÖ</span> Eventi</a></li>
      <li class="sidebar-dropdown">
        <button class="sidebar-dropdown-toggle" type="button" aria-expanded="false"><span>üìÅ</span><span>Progetti</span><span class="dropdown-arrow">‚ñº</span></button>
        <ul class="sidebar-dropdown-menu">
          <li><a href="centrale_meteo.html"><span>üìÑ</span>Centrale Meteorologica</a></li>
        </ul>
      </li>
      <li><a href="chi_siamo.html"><span>üë•</span> Chi siamo</a></li>
      <li><a href="contatti.html"><span>üì®</span> Contatti</a></li>
      <li><a href="documenti.html"><span>üìÉ</span> Documenti</a></li>
      <li><a href="forum.html"><span>üí¨</span> Forum</a></li>
      <li><a href="login.html" id="sidebarLoginLink"><span>üîê</span> Accedi</a></li>
    </ul>

    <div id="mobileUserInfo" class="mobile-user-info" style="display:none;">
      <div class="mobile-user-header">
        <div class="user-avatar" id="mobileUserAvatar" aria-hidden="true"></div>
        <span style="margin-left:0.75rem; font-weight:600;">Account</span>
      </div>
      <div class="mobile-user-display">
        <span class="mobile-user-name" id="mobileUserName"></span>
        <span class="mobile-user-badge" id="mobileUserBadge"></span>
      </div>
      <button class="logout-btn" type="button" onclick="logout()" style="justify-content:center;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M17 7L21 12M21 12L17 17M21 12H9M13 17V18C13 19.6569 11.6569 21 10 21H6C4.34315 21 3 19.6569 3 18V6C3 4.34315 4.34315 3 6 3H10C11.6569 3 13 4.34315 13 6V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Logout</span>
      </button>
    </div>
  </aside>

  <!-- Theme controls -->
  <div id="theme-fab" title="Scegli tema" role="button" aria-haspopup="true" aria-controls="theme-popup">üé®</div>
  <div id="theme-popup" role="menu" aria-label="Seleziona tema">
    <button class="theme-option" data-theme="light" type="button" aria-pressed="false">üåû</button>
    <button class="theme-option" data-theme="dark" type="button" aria-pressed="false">üåô</button>
    <button class="theme-option" data-theme="auto" type="button" aria-pressed="true">üåì</button>
  </div>

  <footer>
    &copy; 2025 Daze for Future. Tutti i diritti riservati.
  </footer>

  <script>
    // ===== CONFIGURAZIONE =====
    (async function () {
      const currentHost = window.location.hostname;
      const protocol = window.location.protocol === 'https:' ? 'https' : 'http';
      const guesses = [
        `${protocol}://${currentHost}:5001`,
        `${protocol}://localhost:5001`,
        `${protocol}://192.168.0.92:5001`
      ];

      async function testEndpoint(url) {
        // Implementiamo un timeout manuale (compatibile Safari)
        const controller = new AbortController();
        const t = setTimeout(() => controller.abort(), 3000);
        try {
          const res = await fetch(`${url}/api/articles`, { method: 'GET', signal: controller.signal });
          return res.ok ? url : null;
        } catch (_) {
          return null;
        } finally {
          clearTimeout(t);
        }
      }

      for (const endpoint of guesses) {
        const ok = await testEndpoint(endpoint);
        if (ok) {
          window.API_BASE_URL = ok;
          console.log('‚úÖ Server API trovato:', ok);
          break;
        }
      }
      if (!window.API_BASE_URL) {
        window.API_BASE_URL = guesses[0];
        console.warn('‚ö†Ô∏è Usando endpoint di default:', window.API_BASE_URL);
      }
    })();

    // ===== STATO GLOBALE =====
    let userRole = 'user';

    // ===== HELPERS =====
    function authHeaders() {
      const email = localStorage.getItem('utente') || '';
      userRole = localStorage.getItem('utente_ruolo') || 'user';
      return { 'X-User-Email': email, 'X-User-Role': userRole };
    }

    function mostraPopup(messaggio, tipo) {
      let popup = document.getElementById('popup');
      if (!popup) {
        popup = document.createElement('div');
        popup.id = 'popup';
        popup.className = 'popup';
        document.body.appendChild(popup);
      }
      popup.textContent = messaggio;
      popup.className = 'popup ' + (tipo || '');
      requestAnimationFrame(() => popup.classList.add('show'));
      setTimeout(() => popup.classList.remove('show'), 3000);
    }

    function escapeHTML(str) {
      return (str || '').replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));
    }

    function getFileExtensionFromPath(filePath) {
      if (!filePath) return '';
      const clean = String(filePath).split('?')[0].split('#')[0];
      const parts = clean.split('.');
      return parts.length > 1 ? parts.pop().toLowerCase() : '';
    }

    function getFileIcon(filePath) {
      const ext = getFileExtensionFromPath(filePath);
      const icons = { pdf: 'üìï', doc: 'üìò', docx: 'üìò', xls: 'üìó', xlsx: 'üìó', ppt: 'üìô', pptx: 'üìô', txt: 'üìÑ', zip: 'üì¶', rar: 'üì¶', jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', png: 'üñºÔ∏è', gif: 'üñºÔ∏è' };
      return icons[ext] || 'üìÑ';
    }

    function getTypeText(type) {
      const map = { statuto: 'Statuto', relazione: 'Relazione', verbale: 'Verbale', bilancio: 'Bilancio', altro: 'Altro' };
      return map[type] || type || 'Altro';
    }

    function stripSystemPrefixes(str) {
      return (str || '').replace(/^\s*(publication|document)\s*[-:]*\s*/i, '').replace(/\b(publication|document)\b/gi, '').replace(/^\s*[-‚Äì‚Äî:]\s*/g, '').trim();
    }

    // ===== AUTH / UI BOOT =====
    document.addEventListener('DOMContentLoaded', () => {
      const utente = localStorage.getItem('utente'); // email intera
      userRole = localStorage.getItem('utente_ruolo') || 'user';

      if (utente) {
        // nascondi link login
        const loginLink = document.getElementById('loginLink');
        if (loginLink) loginLink.style.display = 'none';
        const sidebarLoginLink = document.getElementById('sidebarLoginLink');
        if (sidebarLoginLink) sidebarLoginLink.style.display = 'none';

        // userbar
        const userbar = document.getElementById('userbar');
        if (userbar) {
          userbar.style.display = 'flex';
          document.getElementById('userName').innerText = utente.split('@')[0];
          const badge = document.getElementById('userBadge');
          badge.innerText = userRole === 'admin' ? 'Admin' : 'User';
          badge.className = `user-badge ${userRole === 'admin' ? 'badge-admin' : 'badge-user'}`;
          const avatar = document.getElementById('userAvatar');
          avatar.innerText = (utente.charAt(0) || '?').toUpperCase();
          avatar.setAttribute('aria-label', `Utente ${utente}`);
        }

        // mobile user info
        const mobileUserInfo = document.getElementById('mobileUserInfo');
        if (mobileUserInfo) {
          mobileUserInfo.style.display = 'block';
          document.getElementById('mobileUserName').innerText = utente.split('@')[0];
          const mBadge = document.getElementById('mobileUserBadge');
          mBadge.innerText = userRole === 'admin' ? 'Admin' : 'User';
          mBadge.className = `mobile-user-badge ${userRole === 'admin' ? 'badge-admin' : 'badge-user'}`;
          const mAvatar = document.getElementById('mobileUserAvatar');
          mAvatar.innerText = (utente.charAt(0) || '?').toUpperCase();
        }

        // sezioni per ruolo
        if (userRole === 'admin') {
          document.querySelectorAll('.admin-only').forEach(el => (el.style.display = 'block'));
          document.getElementById('publishedSectionTitle').textContent = 'Tutti gli Articoli';
        } else {
          document.querySelectorAll('.user-only').forEach(el => (el.style.display = 'block'));
          document.getElementById('myDraftsSection').style.display = 'none';
        }

        // pulsante +
        document.getElementById('addDocumentBtn').style.display = 'block';
      }

      // init
      loadArticles();
      initSidebar();
      initTheme();
      initFilters();
      initDocumentTypeSelector();
      initViewerModal();
      initPublicationModal();
      initMobileCreateButton();
    });

    function logout() {
      localStorage.removeItem('utente');
      localStorage.removeItem('utente_ruolo');
      window.location.href = 'login.html';
    }

    // ===== MOBILE CREATE BTN =====
    function initMobileCreateButton() {
      const btn = document.getElementById('mobileCreateBtnLarge');
      if (btn) btn.addEventListener('click', () => (document.getElementById('publicationModal').style.display = 'flex'));
    }

    // ===== FILTRI =====
    function initFilters() {
      const typeFilter = document.getElementById('typeFilter');
      const statusFilter = document.getElementById('statusFilter');
      const dateFilter = document.getElementById('dateFilter');
      const resetFilters = document.getElementById('resetFilters');

      if (typeFilter && statusFilter && dateFilter) {
        typeFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
        dateFilter.addEventListener('change', applyFilters);
        resetFilters.addEventListener('click', resetAllFilters);
      }
    }

    function applyFilters() {
      const typeVal = document.getElementById('typeFilter').value;
      const statusVal = document.getElementById('statusFilter').value;

      document.querySelectorAll('.document-item').forEach((item) => {
        let show = true;
        if (typeVal !== 'all' && (item.getAttribute('data-type') || '') !== typeVal) show = false;
        if (statusVal !== 'all') {
          const isPublished = item.getAttribute('data-status') === 'published';
          if ((statusVal === 'published' && !isPublished) || (statusVal === 'draft' && isPublished)) show = false;
        }
        item.style.display = show ? (item.classList.contains('document-card') ? 'block' : 'flex') : 'none';
      });

      checkEmptyStates();
    }

    function resetAllFilters() {
      document.getElementById('typeFilter').value = 'all';
      document.getElementById('statusFilter').value = 'all';
      document.getElementById('dateFilter').value = 'newest';
      applyFilters();
    }

    function checkEmptyStates() {
      const sections = ['documentList', 'draftList'];
      sections.forEach((id) => {
        const container = document.getElementById(id);
        if (!container) return;
        const visible = Array.from(container.querySelectorAll('.document-item')).some((el) => getComputedStyle(el).display !== 'none');
        const empty = container.querySelector('.empty-state');
        if (empty) empty.style.display = visible ? 'none' : 'block';
      });
    }

    // ===== TYPE SELECTOR =====
    function initDocumentTypeSelector() {
      const options = document.querySelectorAll('.document-type-option');
      const hiddenInput = document.getElementById('publicationType');
      options.forEach((opt) => {
        opt.addEventListener('click', () => {
          options.forEach((o) => { o.classList.remove('selected'); o.setAttribute('aria-pressed', 'false'); });
          opt.classList.add('selected');
          opt.setAttribute('aria-pressed', 'true');
          hiddenInput.value = opt.getAttribute('data-type');
        });
      });
    }

    // ===== PUBLICATION MODAL =====
    function initPublicationModal() {
      const addBtn = document.getElementById('addDocumentBtn');
      const closeBtn = document.getElementById('closeModal');
      const cancelBtn = document.getElementById('cancelPublication');

      if (addBtn) addBtn.addEventListener('click', () => (document.getElementById('publicationModal').style.display = 'flex'));
      if (closeBtn) closeBtn.addEventListener('click', () => (document.getElementById('publicationModal').style.display = 'none'));
      if (cancelBtn) cancelBtn.addEventListener('click', () => (document.getElementById('publicationModal').style.display = 'none'));

      document.getElementById('publicationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await createArticle();
      });
    }

    // ===== VIEWER MODAL =====
    function initViewerModal() {
      const viewerModal = document.getElementById('viewerModal');
      const closeViewer = document.getElementById('closeViewer');
      const closeViewerBtn = document.getElementById('closeViewerBtn');
      const downloadFromViewer = document.getElementById('downloadFromViewer');

      closeViewer.addEventListener('click', () => (viewerModal.style.display = 'none'));
      closeViewerBtn.addEventListener('click', () => (viewerModal.style.display = 'none'));

      downloadFromViewer.addEventListener('click', () => {
        const fileName = viewerModal.getAttribute('data-file-path');
        if (fileName) {
          downloadFile(fileName);
        } else {
          mostraPopup('Impossibile trovare il nome del file.', 'error');
        }
      });

      viewerModal.addEventListener('click', (e) => { if (e.target === viewerModal) viewerModal.style.display = 'none'; });
    }

    async function viewDocument(filePath, title, description) {
      const viewerModal = document.getElementById('viewerModal');
      const viewerTitle = document.getElementById('viewerTitle');
      const viewerBody = document.getElementById('viewerBody');

      viewerTitle.textContent = stripSystemPrefixes(title || 'Documento');
      viewerBody.innerHTML = '<div class="file-preview"><div class="unsupported-format"><p>Caricamento anteprima...</p></div></div>';
      viewerModal.style.display = 'flex';
      viewerModal.setAttribute('data-file-path', filePath);

      try {
        const downloadUrl = `${API_BASE_URL}/documents/${filePath}`;
        const res = await fetch(downloadUrl);
        if (!res.ok) throw new Error('Errore nel recupero del file');
        const blob = await res.blob();
        const fileType = blob.type;
        const url = window.URL.createObjectURL(blob);

        if (fileType.startsWith('image/')) {
          viewerBody.innerHTML = `<div class="file-preview"><img src="${url}" alt="${escapeHTML(title || 'Anteprima documento')}" /><p style="margin-top:1rem; color: var(--muted);">${escapeHTML(description || '')}</p></div>`;
        } else if (fileType === 'application/pdf') {
          viewerBody.innerHTML = `<iframe src="${url}" style="width:100%; height:65vh; border:none; border-radius:8px;"></iframe><p style="margin-top:1rem; color: var(--muted); text-align:center;">${escapeHTML(description || '')}</p>`;
        } else {
          const ext = getFileExtensionFromPath(filePath).toUpperCase();
          viewerBody.innerHTML = `<div class="file-preview"><div class="unsupported-format"><p>Anteprima non disponibile per questo formato (${ext}).</p><p>Scarica il file per visualizzarlo.</p><p style="margin-top:1rem; color: var(--muted);">${escapeHTML(description || '')}</p></div></div>`;
        }

        const cleanup = () => { window.URL.revokeObjectURL(url); viewerModal.removeEventListener('click', cleanup); };
        viewerModal.addEventListener('click', cleanup);
      } catch (error) {
        viewerBody.innerHTML = `<div class="file-preview"><div class="unsupported-format"><p>Errore nel caricamento dell'anteprima: ${escapeHTML(error.message)}</p><p>Scarica il file per visualizzarlo.</p></div></div>`;
      }
    }

    // ===== CRUD ARTICOLI =====
    async function createArticle() {
      const title = document.getElementById('publicationTitle').value.trim();
      const description = document.getElementById('publicationDescription').value.trim();
      const type = document.getElementById('publicationType').value;
      const fileInput = document.getElementById('publicationFile');

      const author = localStorage.getItem('utente') || 'Autore Sconosciuto'; // allinea al resto dell'app
      const publicationDate = new Date().toISOString().slice(0, 10);

      if (!title || !description || !type || !fileInput.files[0]) {
        mostraPopup('Compila tutti i campi richiesti', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('title', title);
      formData.append('description', description);
      formData.append('type', type);
      formData.append('author', author);
      formData.append('publication_date', publicationDate);
      formData.append('document_file', fileInput.files[0]);

      const submitBtn = document.getElementById('submitPublication');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Caricamento...';

      try {
        const res = await fetch(`${API_BASE_URL}/api/articles`, { method: 'POST', body: formData, headers: authHeaders() });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.success) {
          mostraPopup(data.message || 'Articolo creato con successo!', 'success');
          document.getElementById('publicationModal').style.display = 'none';
          document.getElementById('publicationForm').reset();
          document.querySelectorAll('.document-type-option').forEach((o) => o.classList.remove('selected'));
          loadArticles();
        } else {
          mostraPopup('Errore: ' + (data.message || `HTTP ${res.status}`), 'error');
        }
      } catch (error) {
        mostraPopup('Errore di connessione: ' + error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Crea Bozza';
      }
    }

    async function loadArticles() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        const res = await fetch(`${API_BASE_URL}/api/articles`, { signal: controller.signal, headers: authHeaders() });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error(`Errore HTTP: ${res.status}`);
        const data = await res.json();
        const articles = Array.isArray(data.articles) ? data.articles : [];

        const publishedContainer = document.getElementById('documentList');
        const draftContainer = document.getElementById('draftList');
        publishedContainer.innerHTML = '';
        draftContainer.innerHTML = '';

        let publishedCount = 0;
        let draftCount = 0;

        // ordinamento lato client opzionale
        const dateOrder = document.getElementById('dateFilter').value;
        articles.sort((a, b) => {
          const da = new Date(a.publication_date || a.created_at || 0).getTime();
          const db = new Date(b.publication_date || b.created_at || 0).getTime();
          return dateOrder === 'oldest' ? da - db : db - da;
        });

        articles.forEach((article) => {
          const element = createDocumentElement(article);
          if (article.is_published) {
            publishedContainer.appendChild(element);
            publishedCount++;
          } else if (userRole === 'admin') {
            draftContainer.appendChild(element);
            draftCount++;
          }
        });

        document.getElementById('emptyState').style.display = publishedCount === 0 ? 'block' : 'none';
        if (userRole === 'admin') {
          document.getElementById('emptyDrafts').style.display = draftCount === 0 ? 'block' : 'none';
          document.getElementById('reviewSection').style.display = 'block';
        } else {
          document.getElementById('reviewSection').style.display = 'none';
        }

        applyFilters(); // applica filtri correnti alla nuova lista
      } catch (error) {
        console.error('‚ùå Errore caricamento articoli:', error);
        const container = document.getElementById('documentList');
        container.innerHTML = `
          <div class="empty-state">
            <p style="color: var(--error);">Errore di connessione al server</p>
            <p class="text-muted">Impossibile raggiungere il server degli articoli.</p>
            <p class="text-muted">Assicurati che il server sia in esecuzione su ${API_BASE_URL}</p>
            <button class="btn" onclick="loadArticles()" style="margin-top:1rem">
              <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l1.903 1.903h-3.183a.75.75 0 1 0 0 1.5h4.992a.75.75 0 0 0 .75-.75V4.356a.75.75 0 0 0-1.5 0v3.18l-1.9-1.9A9 9 0 0 0 3.306 9.67a.75.75 0 1 0 1.45.388Zm15.408 3.352a.75.75 0 0 0-.919.53 7.5 7.5 0 0 1-12.548 3.364l-1.902-1.903h3.183a.75.75 0 0 0 0-1.5H2.984a.75.75 0 0 0-.75.75v4.992a.75.75 0 0 0 1.5 0v-3.18l1.9 1.9a9 9 0 0 0 15.059-4.035.75.75 0 0 0-.53-.918Z" clip-rule="evenodd" /></svg>
              Riprova
            </button>
          </div>`;
      }
    }

    function createDocumentElement(doc) {
      const item = document.createElement('div');
      item.className = 'document-item';
      item.setAttribute('data-type', doc.type || 'altro');
      item.setAttribute('data-status', doc.is_published ? 'published' : 'draft');

      const isAdmin = userRole === 'admin';
      const isPublished = !!doc.is_published;

      const statusText = isPublished ? 'Pubblicato' : 'Bozza';
      const statusClass = isPublished ? 'status-published' : 'draft-badge';
      const statusBadge = `<span class="status-badge ${statusClass}">${statusText}</span>`;
      const typeBadge = doc.type ? `<span class="type-badge type-${doc.type}">${getTypeText(doc.type)}</span>` : '';

      const info = document.createElement('div');
      info.className = 'document-info';

      const icon = document.createElement('div');
      icon.className = 'document-icon';
      icon.textContent = getFileIcon(doc.file_path);

      const details = document.createElement('div');
      details.className = 'document-details';
      const h3 = document.createElement('h3');
      h3.innerHTML = `${typeBadge} ${escapeHTML(doc.title || 'Documento')} ${statusBadge}`;
      const meta = document.createElement('p');
      const when = new Date(doc.publication_date || Date.now()).toLocaleDateString('it-IT');
      meta.innerHTML = `Caricato da: ${escapeHTML(doc.author || 'Sconosciuto')} (${when})`;
      details.appendChild(h3);
      details.appendChild(meta);

      info.appendChild(icon);
      info.appendChild(details);

      const actions = document.createElement('div');
      actions.className = 'document-actions';

      const viewBtn = document.createElement('button');
      viewBtn.className = 'action-btn view-btn';
      viewBtn.title = 'Visualizza/Scarica';
      viewBtn.setAttribute('aria-label', 'Visualizza/Scarica');
      viewBtn.innerHTML = '<i class="fas fa-eye" aria-hidden="true"></i>';
      viewBtn.addEventListener('click', () => viewDocument(doc.file_path, doc.title, doc.description || ''));
      actions.appendChild(viewBtn);

      if (isAdmin) {
        const pubBtn = document.createElement('button');
        pubBtn.className = `action-btn ${isPublished ? 'unpublish-btn' : 'publish-btn'}`;
        pubBtn.title = isPublished ? 'Metti in revisione' : 'Pubblica Articolo';
        pubBtn.innerHTML = `<i class="fas fa-${isPublished ? 'eye-slash' : 'paper-plane'}" aria-hidden="true"></i>`;
        pubBtn.addEventListener('click', () => togglePublishStatus(doc.id, isPublished));
        actions.appendChild(pubBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'action-btn delete-btn';
        delBtn.title = 'Elimina Articolo e File';
        delBtn.innerHTML = '<i class="fas fa-trash" aria-hidden="true"></i>';
        delBtn.addEventListener('click', () => deleteArticle(doc.id));
        actions.appendChild(delBtn);
      }

      item.appendChild(info);
      item.appendChild(actions);

      return item;
    }

    async function downloadFile(fileName) {
      try {
        const downloadUrl = `${API_BASE_URL}/documents/${fileName}`;
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = fileName;
        a.rel = 'noopener';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        mostraPopup(`Download di ${fileName} avviato.`, 'success');
      } catch (error) {
        mostraPopup('Errore nel scaricare il documento: ' + error.message, 'error');
      }
    }

    async function deleteArticle(id) {
      if (!confirm('Sei sicuro di voler eliminare questo articolo e il file associato?')) return;
      try {
        const res = await fetch(`${API_BASE_URL}/api/articles/${id}`, { method: 'DELETE', headers: authHeaders() });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.success) {
          mostraPopup(data.message || 'Articolo eliminato', 'success');
          loadArticles();
        } else {
          mostraPopup('Errore: ' + (data.message || `HTTP ${res.status}`), 'error');
        }
      } catch (_) {
        mostraPopup('Errore di connessione', 'error');
      }
    }

    async function togglePublishStatus(articleId, currentStatus) {
      if (!confirm(`Sei sicuro di voler ${currentStatus ? 'mettere in revisione' : 'pubblicare'} questo articolo?`)) return;
      try {
        const res = await fetch(`${API_BASE_URL}/api/articles/${articleId}/publish`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ is_published: !currentStatus })
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok && data.success) {
          mostraPopup(data.message || 'Stato aggiornato', 'success');
          loadArticles();
        } else {
          mostraPopup('Errore: ' + (data.message || `HTTP ${res.status}`), 'error');
        }
      } catch (_) {
        mostraPopup('Errore di connessione', 'error');
      }
    }

    // ===== SIDEBAR & THEME =====
    function initSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarClose = document.querySelector('.sidebar-close');
      const toggleSidebar = document.getElementById('toggleSidebar');

      sidebarToggle.addEventListener('click', () => sidebar.classList.add('open'));
      toggleSidebar.addEventListener('click', () => sidebar.classList.add('open'));
      sidebarClose.addEventListener('click', () => sidebar.classList.remove('open'));

      document.addEventListener('click', (e) => {
        if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target) && !toggleSidebar.contains(e.target) && sidebar.classList.contains('open')) {
          sidebar.classList.remove('open');
        }
      });
    }

    function initTheme() {
      const fab = document.getElementById('theme-fab');
      const popup = document.getElementById('theme-popup');

      fab.addEventListener('click', () => {
        fab.classList.add('animate');
        fab.addEventListener('animationend', () => fab.classList.remove('animate'), { once: true });
        if (popup.classList.contains('show')) {
          popup.classList.remove('show');
          setTimeout(() => (popup.style.display = 'none'), 250);
        } else {
          popup.style.display = 'flex';
          requestAnimationFrame(() => popup.classList.add('show'));
        }
      });

      document.addEventListener('click', (e) => {
        if (!fab.contains(e.target) && !popup.contains(e.target)) {
          if (popup.classList.contains('show')) {
            popup.classList.remove('show');
            setTimeout(() => (popup.style.display = 'none'), 250);
          }
        }
      });

      document.querySelectorAll('.theme-option').forEach((btn) => {
        btn.addEventListener('click', () => {
          const theme = btn.dataset.theme;
          localStorage.setItem('theme-preference', theme);
          applyTheme(theme);
          document.querySelectorAll('.theme-option').forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          popup.classList.remove('show');
          setTimeout(() => (popup.style.display = 'none'), 250);
        });
      });

      function applyTheme(theme) {
        if (theme === 'light') document.documentElement.setAttribute('data-theme', 'light');
        else if (theme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        else document.documentElement.removeAttribute('data-theme');
      }

      const savedTheme = localStorage.getItem('theme-preference');
      applyTheme(savedTheme || 'auto');
      const activeBtn = document.querySelector(`.theme-option[data-theme="${savedTheme || 'auto'}"]`);
      if (activeBtn) activeBtn.classList.add('active');

      fab.classList.add('show');
    }
  </script>
  <script src="css/sidebar/sidebar.js"></script>
</body>
</html>
